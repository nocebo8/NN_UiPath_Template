name: UiPath Orchestrator Pipeline

on:
  pull_request:
  push:
    branches: [ master ]

jobs:
  pack:
    runs-on: windows-latest
    outputs:
      pack_status: ${{ steps.pack-step.outcome }}
    steps:
      - uses: actions/checkout@v4

      - name: Download NuGet
        shell: pwsh
        run: |
          curl -L -o nuget.exe https://dist.nuget.org/win-x86-commandline/latest/nuget.exe

      - name: Configure UiPath NuGet feed (authenticated)
        if: ${{ secrets.UIPATH_FEED_PAT != '' }}
        shell: pwsh
        env:
          UIPATH_FEED_PAT: ${{ secrets.UIPATH_FEED_PAT }}
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not $env:UIPATH_FEED_PAT) { Write-Host 'Missing secret UIPATH_FEED_PAT'; exit 1 }
          $feed = 'https://pkgs.dev.azure.com/uipath/Public.Feeds/_packaging/UiPath-Official/nuget/v3/index.json'
          dotnet --info | Out-Null
          dotnet nuget remove source UiPath-Official 2>$null | Out-Null
          dotnet nuget add source $feed --name UiPath-Official --username user --password "$env:UIPATH_FEED_PAT" --store-password-in-clear-text

      - name: Install UiPath CLI
        if: ${{ secrets.UIPATH_FEED_PAT != '' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Path .\uipath-cli -Force | Out-Null
          & .\nuget.exe install UiPath.CLI.Windows -Source UiPath-Official -OutputDirectory .\uipath-cli -NonInteractive -DirectDownload
          if ($LASTEXITCODE -ne 0) { Write-Host 'nuget install failed'; exit 1 }

      - name: Run pack and capture log
        if: ${{ secrets.UIPATH_FEED_PAT != '' }}
        id: pack-step
        shell: pwsh
        run: |
          $cli = Get-ChildItem .\uipath-cli -Recurse -Filter uipcli.exe | Select-Object -First 1
          if (-not $cli) { Write-Host "uipcli.exe not found"; Get-ChildItem .\uipath-cli -Recurse; exit 1 }
          & $cli.FullName pack --input "Golden_Template" --output ".\dist" --version "1.0.${{ github.run_number }}" --type Process 2>&1 | Tee-Object pack.log
        continue-on-error: false

      - name: Skip pack (no UIPATH_FEED_PAT provided)
        if: ${{ secrets.UIPATH_FEED_PAT == '' }}
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path .\dist -Force | Out-Null
          "SKIPPED_PACK: missing UIPATH_FEED_PAT secret; running only XAML validation in hosted pipeline." | Out-File -FilePath pack.log -Encoding UTF8

      - name: Upload pack artifacts and log
        uses: actions/upload-artifact@v4
        with:
          name: uipath-pack-results
          path: |
            .\dist\*.nupkg
            pack.log

  analyze:
    needs: pack
    runs-on: ubuntu-latest
    outputs:
      has_errors: ${{ steps.scan.outputs.has_errors }}
    steps:
      - name: Download pack artifacts
        uses: actions/download-artifact@v4
        with:
          name: uipath-pack-results
          path: ./uipath-pack-results

      - name: Inspect pack.log
        id: scan
        run: |
          if [ -f ./uipath-pack-results/pack.log ]; then
            echo "---- tail pack.log ----"
            tail -n 200 ./uipath-pack-results/pack.log || true
            if grep -q "SKIPPED_PACK:" ./uipath-pack-results/pack.log; then
              echo "Pack was skipped by configuration (no secret); treating as success."
              echo "has_errors=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            if grep -i -E "exception|error|failed|Unable to find package" ./uipath-pack-results/pack.log >/dev/null; then
              echo "Pack produced errors."
              echo "has_errors=true" >> "$GITHUB_OUTPUT"
            else
              echo "No obvious errors found in pack.log."
              echo "has_errors=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "pack.log not found in artifacts"
            echo "has_errors=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Post PR comment with summary
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const conclusion = (await github.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: parseInt(process.env.GITHUB_RUN_ID)
            })).data.conclusion || 'unknown';
            const body = `UiPath orchestration run [#${process.env.GITHUB_RUN_ID}](${runUrl}) concluded: **${conclusion}**.\n\nArtifacts: uipath-pack-results (pack.log + .nupkg if produced).`;
            await github.issues.createComment({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
              body
            });

  autofix:
    needs: analyze
    if: ${{ needs.analyze.outputs.has_errors == 'true' && github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Attempt simple fixes
        run: |
          set -euo pipefail
          sudo apt-get update -y >/dev/null 2>&1 || true
          sudo apt-get install -y jq >/dev/null 2>&1 || true
          FILE="Golden_Template/project.json"
          if [ -f "$FILE" ]; then
            TMP=$(mktemp)
            jq '.dependencies |= (."UiPath.System.Activities"="[24.10.0,25.0.0)", ."UiPath.UIAutomation.Activities"="[24.10.0,25.0.0)", ."UiPath.Excel.Activities"="[2.24.0,3.0.0)", ."UiPath.Testing.Activities"="[24.10.0,25.0.0)")' "$FILE" > "$TMP" && mv "$TMP" "$FILE"
            echo "Adjusted dependency ranges in project.json"
          else
            echo "project.json not found; skipping dependency adjustments"
          fi
      - name: Commit and push fixes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          if ! git diff --quiet; then
            git add -A
            git commit -m "ci: widen UiPath Activities dependency ranges to fix pack"
            git push
          else
            echo "No changes to push."
          fi